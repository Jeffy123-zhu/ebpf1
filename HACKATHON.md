# eBPF Time Machine - é»‘å®¢æ¾æäº¤

## ðŸŽ¯ é¡¹ç›®æ¦‚è¿°

**eBPF Time Machine** æ˜¯ä¸€ä¸ªåˆ›æ–°çš„è°ƒè¯•å·¥å…·ï¼Œåˆ©ç”¨ eBPF æŠ€æœ¯å®žçŽ°"æ—¶é—´æ—…è¡Œ"å¼çš„ç¨‹åºè°ƒè¯•ä½“éªŒã€‚å½“ç¨‹åºå´©æºƒæ—¶ï¼Œå®ƒèƒ½è®©ä½ "å€’å¸¦"åˆ°å´©æºƒå‰çš„ä»»æ„æ—¶åˆ»ï¼ŒæŸ¥çœ‹æ‰€æœ‰ç›¸å…³äº‹ä»¶ï¼Œå°±åƒæ‹¥æœ‰äº†ä¸€å°æ—¶å…‰æœºå™¨ã€‚

## ðŸ’¡ åˆ›æ„æ¥æº

è°ƒè¯•ç¨‹åºå´©æºƒæ˜¯æ¯ä¸ªå¼€å‘è€…çš„å™©æ¢¦ï¼š
- å´©æºƒå‘ç”Ÿæ—¶ï¼ŒçŽ°åœºå·²ç»è¢«ç ´å
- ä¼ ç»Ÿè°ƒè¯•å™¨åªèƒ½çœ‹åˆ°å´©æºƒçž¬é—´çš„çŠ¶æ€
- å¾ˆéš¾è¿½æº¯å´©æºƒçš„æ ¹æœ¬åŽŸå› 

**eBPF Time Machine çš„è§£å†³æ–¹æ¡ˆ**ï¼š
- æŒç»­è®°å½•ç¨‹åºçš„æ‰€æœ‰å…³é”®äº‹ä»¶
- é›¶å¼€é”€ï¼ˆeBPF åœ¨å†…æ ¸æ€è¿è¡Œï¼‰
- å´©æºƒæ—¶è‡ªåŠ¨è§¦å‘åˆ†æž
- å¯ä»¥"å€’å¸¦"æŸ¥çœ‹å´©æºƒå‰çš„å®Œæ•´ä¸Šä¸‹æ–‡

## ðŸš€ æŠ€æœ¯äº®ç‚¹

### 1. eBPF æ ¸å¿ƒæŠ€æœ¯

- **Uprobe/Uretprobe**ï¼šè¿½è¸ªç”¨æˆ·æ€å‡½æ•°è°ƒç”¨
- **Tracepoint**ï¼šæ•èŽ·ç³»ç»Ÿäº‹ä»¶å’Œä¿¡å·
- **Ring Buffer**ï¼šé«˜æ•ˆçš„å†…æ ¸-ç”¨æˆ·æ€æ•°æ®ä¼ è¾“
- **Stack Traces**ï¼šå®Œæ•´çš„è°ƒç”¨æ ˆè®°å½•
- **BPF Maps**ï¼šçŠ¶æ€è¿½è¸ªå’Œè¿‡æ»¤

### 2. åˆ›æ–°ç‰¹æ€§

- **æ—¶é—´æ—…è¡Œè°ƒè¯•**ï¼šå¯ä»¥æŸ¥çœ‹å´©æºƒå‰åŽä»»æ„æ—¶é—´çª—å£
- **è‡ªåŠ¨å´©æºƒæ£€æµ‹**ï¼šæ•èŽ· SIGSEGVã€SIGABRT ç­‰è‡´å‘½ä¿¡å·
- **å†…å­˜æ³„æ¼åˆ†æž**ï¼šè¿½è¸ªæ‰€æœ‰ malloc/free æ“ä½œ
- **é›¶é…ç½®**ï¼šåªéœ€æä¾› PID å³å¯å¼€å§‹è¿½è¸ª

### 3. å®žç”¨ä»·å€¼

- **Use-After-Free æ£€æµ‹**ï¼šæ¼”ç¤ºç¨‹åºå±•ç¤ºäº†å¦‚ä½•å‘çŽ°è¿™ç±» bug
- **å†…å­˜æ³„æ¼åˆ†æž**ï¼šè‡ªåŠ¨ç»Ÿè®¡æœªé‡Šæ”¾çš„å†…å­˜
- **æ€§èƒ½åˆ†æž**ï¼šè®°å½•å‡½æ•°è°ƒç”¨å’Œæ‰§è¡Œæ—¶é—´
- **ç”Ÿäº§çŽ¯å¢ƒå‹å¥½**ï¼šä½Žå¼€é”€ï¼Œå¯ä»¥åœ¨ç”Ÿäº§çŽ¯å¢ƒä½¿ç”¨

## ðŸ“Š æ¼”ç¤ºåœºæ™¯

### åœºæ™¯ï¼šè°ƒè¯• Use-After-Free Bug

1. **è¿è¡Œæœ‰ bug çš„ç¨‹åº**ï¼š
```bash
./build/crash_demo &
```

2. **å¯åŠ¨ Time Machine**ï¼š
```bash
sudo ./build/timemachine record $(pgrep crash_demo)
```

3. **è‡ªåŠ¨æ£€æµ‹å´©æºƒ**ï¼š
```
ðŸš¨ CRASH DETECTED!
Timestamp: 1234567890123456
Signal: SIGSEGV
PID: 12345
```

4. **æ—¶é—´å€’å¸¦åˆ†æž**ï¼š
```bash
sudo ./build/timemachine rewind 1234567890123456
```

5. **æŸ¥çœ‹å´©æºƒå‰çš„äº‹ä»¶åºåˆ—**ï¼š
```
    1234567885000000  ALLOC   0x7f1234567890  size=1024
    1234567886000000  FUNC    process_request  args=42
    1234567887000000  FREE    0x7f1234567890  (freed)
    1234567888000000  FUNC    printf          args=...
>>> 1234567890123456  CRASH   SIGSEGV         sig=11
```

**ç»“è®º**ï¼šæ¸…æ¥šåœ°çœ‹åˆ°å†…å­˜åœ¨ä½¿ç”¨å‰è¢«é‡Šæ”¾äº†ï¼

## ðŸŽ“ æ•™è‚²ä»·å€¼

è¿™ä¸ªé¡¹ç›®å±•ç¤ºäº†ï¼š

1. **eBPF çš„å¼ºå¤§èƒ½åŠ›**ï¼š
   - å†…æ ¸æ€ç¼–ç¨‹
   - ç”¨æˆ·æ€ç¨‹åºè¿½è¸ª
   - é«˜æ•ˆçš„æ•°æ®æ”¶é›†

2. **å®žç”¨çš„è°ƒè¯•æŠ€æœ¯**ï¼š
   - äº‹ä»¶é©±åŠ¨çš„è°ƒè¯•
   - æ—¶é—´åºåˆ—åˆ†æž
   - å†…å­˜è¿½è¸ª

3. **ç³»ç»Ÿç¼–ç¨‹æœ€ä½³å®žè·µ**ï¼š
   - BPF ç¨‹åºè®¾è®¡
   - ç”¨æˆ·æ€-å†…æ ¸æ€äº¤äº’
   - é«˜æ€§èƒ½æ•°æ®ç»“æž„

## ðŸ”§ æŠ€æœ¯æž¶æž„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         User Space                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Time Machine (main.c)           â”‚  â”‚
â”‚  â”‚  - Event collection              â”‚  â”‚
â”‚  â”‚  - Analysis & visualization      â”‚  â”‚
â”‚  â”‚  - Time travel interface         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â†• Ring Buffer              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         Kernel Space (eBPF)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  tracer.bpf.c                    â”‚  â”‚
â”‚  â”‚  - Function probes               â”‚  â”‚
â”‚  â”‚  - Memory tracking               â”‚  â”‚
â”‚  â”‚  - Signal handling               â”‚  â”‚
â”‚  â”‚  - Stack traces                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ðŸ“ˆ æ€§èƒ½æŒ‡æ ‡

- **äº‹ä»¶æ•èŽ·é€Ÿåº¦**ï¼š> 100,000 events/sec
- **å†…å­˜å¼€é”€**ï¼š~256MB ring buffer
- **CPU å¼€é”€**ï¼š< 5% (å–å†³äºŽè¿½è¸ªå¯†åº¦)
- **å»¶è¿Ÿ**ï¼š< 1Î¼s per event

## ðŸŒŸ æœªæ¥æ‰©å±•

1. **å¯è§†åŒ–ç•Œé¢**ï¼š
   - Web UI å±•ç¤ºäº‹ä»¶æ—¶é—´çº¿
   - äº¤äº’å¼æ—¶é—´æ—…è¡Œ
   - å›¾å½¢åŒ–è°ƒç”¨æ ˆ

2. **æ›´å¤šè¿½è¸ªèƒ½åŠ›**ï¼š
   - ç½‘ç»œäº‹ä»¶è¿½è¸ª
   - çº¿ç¨‹åŒæ­¥è¿½è¸ª
   - æ–‡ä»¶ I/O åˆ†æž

3. **é›†æˆ Cilium**ï¼š
   - ç½‘ç»œç­–ç•¥è¿½è¸ª
   - Service Mesh è°ƒè¯•
   - åˆ†å¸ƒå¼è¿½è¸ª

4. **AI è¾…åŠ©åˆ†æž**ï¼š
   - è‡ªåŠ¨è¯†åˆ«å¸¸è§ bug æ¨¡å¼
   - æ™ºèƒ½æŽ¨èä¿®å¤æ–¹æ¡ˆ
   - å¼‚å¸¸æ£€æµ‹

## ðŸ† ä¸ºä»€ä¹ˆè¿™ä¸ªé¡¹ç›®å€¼å¾—å…³æ³¨

1. **è§£å†³çœŸå®žé—®é¢˜**ï¼šè°ƒè¯•å´©æºƒæ˜¯æ¯ä¸ªå¼€å‘è€…éƒ½ä¼šé‡åˆ°çš„éš¾é¢˜
2. **æŠ€æœ¯åˆ›æ–°**ï¼šå°† eBPF åº”ç”¨äºŽæ—¶é—´æ—…è¡Œè°ƒè¯•
3. **æ˜“äºŽä½¿ç”¨**ï¼šç®€å•çš„å‘½ä»¤è¡Œç•Œé¢ï¼Œé›¶é…ç½®
4. **æ•™è‚²ä»·å€¼**ï¼šå±•ç¤º eBPF çš„å®žç”¨åœºæ™¯
5. **å¯æ‰©å±•æ€§**ï¼šæž¶æž„è®¾è®¡æ”¯æŒå¤šç§æ‰©å±•æ–¹å‘

## ðŸ“š å­¦ä¹ èµ„æº

é¡¹ç›®ä¸­ä½¿ç”¨çš„ eBPF æŠ€æœ¯ï¼š
- [eBPF å®˜æ–¹æ–‡æ¡£](https://ebpf.io/)
- [libbpf æ–‡æ¡£](https://libbpf.readthedocs.io/)
- [BPF CO-RE](https://nakryiko.com/posts/bpf-portability-and-co-re/)

## ðŸŽ¬ æ¼”ç¤ºè§†é¢‘è„šæœ¬

1. **ä»‹ç»** (30s)
   - å±•ç¤ºé¡¹ç›® logo å’Œæ¦‚å¿µ
   - è¯´æ˜Žè¦è§£å†³çš„é—®é¢˜

2. **å¿«é€Ÿæ¼”ç¤º** (2min)
   - è¿è¡Œ crash_demo
   - å¯åŠ¨ Time Machine
   - å±•ç¤ºå´©æºƒæ£€æµ‹
   - æ—¶é—´å€’å¸¦åˆ†æž

3. **æŠ€æœ¯æ·±å…¥** (2min)
   - å±•ç¤º eBPF ä»£ç 
   - è§£é‡Šå·¥ä½œåŽŸç†
   - æ€§èƒ½æŒ‡æ ‡

4. **æ€»ç»“** (30s)
   - é¡¹ç›®ä»·å€¼
   - æœªæ¥æ–¹å‘

## ðŸ“ž è”ç³»æ–¹å¼

- GitHub: [é¡¹ç›®é“¾æŽ¥]
- æ¼”ç¤ºè§†é¢‘: [è§†é¢‘é“¾æŽ¥]
- æ–‡æ¡£: README.md

---

**è®©è°ƒè¯•åƒæ—¶é—´æ—…è¡Œä¸€æ ·ç®€å•ï¼** â°âœ¨
